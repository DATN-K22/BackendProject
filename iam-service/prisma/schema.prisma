generator client {
  provider = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  user
  admin
}

enum EventStatus {
  CONFIRMED
  TENTATIVE
  CANCELLED
}

model User {
  id            String    @id @default(uuid(7)) @db.Uuid
  email         String    @unique
  password_hash String
  first_name    String?
  last_name     String?
  avt_url       String?
  role          UserRole  @default(user)
  created_at    DateTime  @default(now()) @db.Timestamptz
  
  // Store course IDs from course-service 
  owned_course_ids BigInt[] @default([])
  enroll_course    BigInt[] @default([])

  // Relations
  events        Event[]
  skills        UserSkill[]
}

model Skill {
  id            BigInt        @id @default(autoincrement())
  name          String        @unique @db.VarChar(100)

  // Relations
  users         UserSkill[]
}

model UserSkill {
  user_id       String
  skill_id      BigInt

  // Relations
  user          User    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  skill         Skill   @relation(fields: [skill_id], references: [id], onDelete: Cascade)

  @@id([user_id, skill_id])
}

model Event {
  id               BigInt   @id @default(autoincrement())
  user_id          String
  uid              String   @unique @default(uuid()) @db.VarChar(255)
  title            String   @db.VarChar(255)
  description      String?  @db.Text
  location         String?  @db.VarChar(255)
  status           EventStatus @default(CONFIRMED)
  time_start       DateTime @db.Timestamptz
  time_end         DateTime @db.Timestamptz
  timezone         String?  @default("UTC") @db.VarChar(50) 
  rrule_string     String?  @db.Text
  sequence         Int      @default(0)
  created_at       DateTime @default(now()) @db.Timestamptz
  updated_at       DateTime @updatedAt @db.Timestamptz 
  recurrence_id    DateTime? @db.Timestamptz
  original_event_id BigInt?
  
  // Relations
  user             User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  original_event   Event?   @relation("RecurringExceptions", fields: [original_event_id], references: [id])
  exceptions       Event[]  @relation("RecurringExceptions")
  exception_dates  EventExceptionDate[]
}

model EventExceptionDate {
  id              BigInt   @id @default(autoincrement())
  event_id        BigInt
  exception_date  DateTime @db.Date // Ngày bị loại bỏ khỏi chuỗi lặp
  reason          String?  @db.VarChar(255)

  event           Event    @relation(fields: [event_id], references: [id], onDelete: Cascade)
}



